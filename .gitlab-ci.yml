stages:
  - build
  - test
  - quality
  - scan
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "ğŸ”§ Building services..."
    - docker build -t auth-service ./service-auth
    - docker build -t product-service ./service-product
    - docker build -t cart-service ./service-cart
  only:
    - main
    - merge_requests

test:
  stage: test
  image: node:18
  script:
    - echo "ğŸ§ª Running tests..."
    - cd service-auth && npm install && npm test
    - cd ../service-product && npm install && npm test
    - cd ../service-cart && npm install && npm test
  only:
    - main
    - merge_requests

quality:
  stage: quality
  image: sonarsource/sonar-scanner-cli:latest
  script:
    - echo "ğŸ“Š Running SonarCloud analysis..."
    - sonar-scanner 
        -Dsonar.projectKey=VibhavKhaneja_project
        -Dsonar.organization=vibhavkhaneja
        -Dsonar.sources=.
        -Dsonar.host.url=https://sonarcloud.io
        -Dsonar.login=$SONAR_TOKEN
        -Dsonar.branch.name=main
  only:
    - main
    - merge_requests
    
scan:
  stage: scan
  image: aquasec/trivy:latest
  script:
    - echo "ğŸ” Scanning auth-service for vulnerabilities..."
    - trivy fs ./service-auth
    - echo "ğŸ” Scanning product-service for vulnerabilities..."
    - trivy fs ./service-product
    - echo "ğŸ” Scanning cart-service for vulnerabilities..."
    - trivy fs ./service-cart
  only:
    - main
    - merge_requests


deploy:
  stage: deploy
  image: docker/compose:latest
  services:
    - docker:dind
  script:
    - echo "ğŸš€ Deploying with Docker Compose..."
    - docker-compose up -d --build
  only:
    - tags
