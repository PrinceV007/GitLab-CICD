stages:
  - build
  - test
  - quality
  - scan
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Building services..."
    - docker build -t auth-service ./service-auth
    - docker build -t product-service ./service-product
    - docker build -t cart-service ./service-cart
  only:
    - main
    - merge_requests

test:
  stage: test
  image: node:18
  script:
    - echo "Running tests..."
    - cd service-auth && npm install && npm test
    - cd ../service-product && npm install && npm test
    - cd ../service-cart && npm install && npm test
  only:
    - main
    - merge_requests

quality:
  stage: quality
  image: sonarsource/sonar-scanner-cli:latest
  script:
    - echo "Running SonarCloud analysis..."
    - sonar-scanner
        -Dsonar.projectKey=nodejs-monorepo
        -Dsonar.organization=vibhavkhaneja
        -Dsonar.sources=.
        -Dsonar.host.url=https://sonarcloud.io
        -Dsonar.login=$SONAR_TOKEN
  only:
    - main
    - merge_requests

deploy:
  stage: deploy
  image: docker/compose:latest
  services:
    - docker:dind
  script:
    - echo "ðŸš€ Deploying with Docker Compose..."
    - docker-compose up -d --build
  only:
    - tags
